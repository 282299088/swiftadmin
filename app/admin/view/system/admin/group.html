<include file="/public/header" />

<div class="layui-fluid">
    <div class="layui-card">
        <!-- // 默认操作按钮 -->
        <div class="layui-card-header layuiadmin-card-header-auto ">
        <div class="layui-form">
            <div class="layui-form-item">
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input name="title" class="layui-input" type="text" placeholder="{:__('角色名称')}"/>
                </div>
            </div>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input name="alias" class="layui-input" type="text" placeholder="{:__('角色标识')}"/>
                </div>
            </div>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input name="content" class="layui-input" type="text" placeholder="{:__('备注查询')}"/>
                </div>
            </div>
            <div class="layui-inline" >
                <!-- // 默认搜索 -->
                <button class="layui-btn icon-btn" lay-filter="formSearch" lay-submit><i class="layui-icon layui-icon-search"></i>{:__('搜索')}</button>
                <!-- // 打开添加页面 -->
                <button class="layui-btn icon-btn" lay-open="" lay-title="{:__('添加角色')}" lay-area="600px" lay-url="#editforms" >
                    <i class="layui-icon layui-icon-add-1"></i>{:__('添加')}
                </button>
            </div>
            </div>
        </div>   
        </div>

        <!-- // 创建数据表实例 -->
        <table id="lay-tableList" lay-filter="lay-tableList"></table>        
    </div>
</div>

<!-- // 添加编辑栏目 -->
<script type="text/html" id="editforms" >
<div class="layui-fluid layui-bg-white" >
    <form class="layui-form layui-form-fixed" lay-filter="editforms" >
    <input type="text" name="id" hidden="">
    <div class="layui-form-item">
        <label class="layui-form-label"><font color="red">* </font>{:__('父级角色')}</label>
        <div class="layui-input-block">
            <select name="pid" lay-verType="tips" lay-verify="required" > <volist name="$group" id="vo" >
                <option value="{$vo.id}">{$vo.title}</option>
                </volist>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"><font color="red">* </font>{:__('角色名称')}</label>
        <div class="layui-input-block">
            <input name="title" placeholder="{:__('请角色名称')}" type="text" class="layui-input" lay-verType="tips"lay-verify="required" />
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">{:__('角色标识')}</label>
        <div class="layui-input-block">
            <input name="alias" placeholder="{:__('请角色标识')}" type="text" class="layui-input"  lay-verType="tips"lay-verify="required" />
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">{:__('角色备注')}</label>
        <div class="layui-input-block">
            <textarea name="content" id="content" cols="30" rows="10" style="min-height: 110px;" placeholder="{:__('请输入角色备注')}" class="layui-textarea" 
            lay-verType="tips"lay-verify="required"></textarea>
        </div>
    </div>

    <div class="layui-footer layui-form-item layui-center"  >
        <button class="layui-btn layui-btn-primary" type="button" sa-event="closePageDialog" >{:__('取消')}</button>
        <button class="layui-btn" lay-add="{:url('/system.admingroup/add')}" lay-edit="{:url('/system.admingroup/edit')}" lay-filter="submitPage"  lay-submit>{:__('提交')}</button>
    </div>
    </form>
</div>
</script>

<!-- // 编辑权限列表 -->
<script type="text/html" id="authForms">
<div class="layui-fluid layui-bg-white" >
    <form action="{:url('/system.admingroup/editrules')}" class="layui-form">
    <div class="layui-authtree"  style="padding-left: 15px"><div id="authTree"></div></div>
    <div class="layui-footer layui-form-item layui-center "  >
        <button class="layui-btn layui-btn-primary" type="button" sa-event="closePageDialog" >{:__('取消')}</button>
        <button class="layui-btn" lay-filter="submitPage" lay-submit>{:__('提交')}</button>
    </div>
    </form>
</div>
</script>

<!-- // 栏目权限列表 -->
<script type="text/html" id="cateForms">
<div class="layui-fluid layui-bg-white" >
    <form action="{:url('/system.admingroup/editcate')}" class="layui-form">
    <div class="layui-authtree" style="padding-left: 15px"><div id="cateTree"></div></div>
    <div class="layui-footer layui-form-item layui-center "  >
        <button class="layui-btn layui-btn-primary" type="button" sa-event="closePageDialog" >{:__('取消')}</button>
        <button class="layui-btn" lay-filter="submitPage" lay-submit>{:__('提交')}</button>
    </div>
    </form>
</div>
</script>

<!-- // 列表工具栏 -->
<script type="text/html" id="tableBar">
    <a class="layui-table-text" lay-title="{:__('编辑')} {{d.title}}" lay-area="500px" lay-url="#editforms"  lay-event="edit" >{:__('编辑')}</a>
    <div class="layui-divider layui-divider-vertical"></div>
    <a class="layui-table-text"lay-callback="auth"lay-area="300px" lay-title="{{d.title}}{:__('权限')}" lay-url="#authForms" lay-event="auth">{:__('访问权限')}</a>
    <div class="layui-divider layui-divider-vertical"></div>
    <a class="layui-table-text" lay-callback="cate" lay-area="300px" lay-title="{:__('栏目权限')}" lay-url="#cateForms"  lay-event="cate" >{:__('栏目权限')}</a>
    <div class="layui-divider layui-divider-vertical"></div>
    <a class="layui-table-text" lay-url="{:url('/system.admingroup/del/')}id/{{d.id}}" lay-event="del" >{:__('删除')}</a>
</script>


<include file="/public/footer" />
<script>
    layui.use(['admin','layer','table','eleTree','form'], function () {
        var jquery = layui.jquery;
        var admin = layui.admin;
        var eleTree = layui.eleTree;
        var form = layui.form;
        var layer = layui.layer;
        var table = layui.table;

        /*
         * 初始化表格
        */
        var isTable = table.render({
            elem: "#lay-tableList"
            ,url: "{:url('/system.admingroup/index')}"
            ,page: true
            ,cols: [[
                {type: 'checkbox', width:45},
                {field: 'id', align: 'center',sort: true,width: 80,  title: 'ID'},
                {field: 'title', align: 'center', title: "{:__('名称')}"},
                {field: 'alias', align: 'center', title: "{:__('角色标识')}"},
                {field: 'content', align: 'center',title: "{:__('角色备注')}"},
                {field: 'createtime', align: 'center',title: "{:__('添加时间')}"},
                {align: 'center', toolbar: '#tableBar',width: 330, title: "{:__('操作')}"},
            ]]
        })


        /*
         * 角色回调函数
         * 
        */
        admin.callback.auth = function(clickthis,colletction,config) {

            // 获取表格对象
            var tableThis = colletction.tableThis,checkKeys = [];
                
            // 勾选默认权限
            if (typeof (tableThis.data.rules) !== undefined && tableThis.data.rules != null) {
                checkKeys = tableThis.data.rules.split(',');
                for(var i in checkKeys) {
                    checkKeys[i] = parseInt(checkKeys[i]);
                }
            }

            // 创建实例
            var tree = eleTree({
                el: '#authTree',
                data: admin.event.getAjaxData("{:url('/system.admingroup/queryrules')}"),
                highlightCurrent: true,
                showCheckbox: true,
                showLine: false,
                defaultPid: 0,
                request: {
                    name: "title",
                },
                defaultCheckedKeys: checkKeys,
            })
           
            // 监听提交
            form.on("submit(submitPage)",function(post){
                // 获取提交地址
                var pageThat = jquery(this), _form = pageThat.parents('form'), 
                rules = [],_pageUrl = _form.attr("action") || pageThat.attr('lay-url');
                
                if (typeof(_pageUrl) === 'undefined') {
                    layui.iziToast.error({
                        message: "缺少 url 属性",
                    });
                    return false;
                }
                
                // 遍历节点数据
                var nodes = tree.getChecked(false,true);
                for (var i in nodes) {
                    rules.push(nodes[i].id);
                }

                // 增加角色id
                post.field.id = tableThis.data.id;
                // 增加节点数据
                post.field.rules = rules;

                // 开始POST提交数据
                jquery.post(_pageUrl, 
                    post.field, function(res){
                        if (res.code == 200) {
                            layui.iziToast.success({
                                message: res.msg,
                            });
                            // 更新本地规则
                            rules = rules.join(',');
                            tableThis.update({
                                rules: rules
                            });

                            table.reload('lay-tableList');
                            // 关闭当前窗口
                            layer.close(colletction.index);
                        }else{
                            layui.iziToast.error({
                                message: res.msg,
                            });
                        }
                }, 'json');

                return false;                        
            })
        }

        /**
         * 栏目权限回调函数
        */
        admin.callback.cate = function(clickthis,colletction,config) {

            // 获取表格对象
            var tableThis = colletction.tableThis,checkKeys = [];
            // 勾选默认权限
            if (typeof (tableThis.data.cateids) !== undefined && tableThis.data.cateids != null) {
                checkKeys = tableThis.data.cateids.split(',');
                for(var i in checkKeys) {
                    checkKeys[i] = parseInt(checkKeys[i]);
                }
            }

            // 创建实例
            var tree = eleTree({
                el: '#cateTree',
                data: admin.event.getAjaxData("{:url('/system.admingroup/querycate')}"),
                highlightCurrent: true,
                showCheckbox: true,
                showLine: false,
                defaultPid: 0,
                request: {
                    name: "title",
                },
                defaultCheckedKeys: checkKeys,
            })

            // 监听提交
            form.on("submit(submitPage)",function(post){
                // 获取提交地址
                var pageThat = jquery(this), _form = pageThat.parents('form'), 
                cateids = [],_pageUrl = _form.attr("action") || pageThat.attr('lay-url');
                
                if (typeof(_pageUrl) === 'undefined') {
                    layui.iziToast.error({
                        message: "缺少 url 属性",
                    });
                    return false;
                }
                
                // 遍历节点数据
                var nodes = tree.getChecked(false,true);
                for (var i in nodes) {
                    cateids.push(nodes[i].id);
                }

                // 增加角色id
                post.field.id = tableThis.data.id;
                // 增加节点数据
                post.field.cateids = cateids;

                // 开始POST提交数据
                jquery.post(_pageUrl, 
                    post.field, function(res){
                        if (res.code == 200) {
                            layui.iziToast.success({
                                message: res.msg,
                            });
                            // 更新栏目权限
                            cateids = cateids.join(',');
                            tableThis.update({
                                cateids: cateids
                            });

                            table.reload('lay-tableList');
                            // 关闭当前窗口
                            layer.close(colletction.index);
                        }else{
                            layui.iziToast.error({
                                message: res.msg,
                            });
                        }
                }, 'json');

                return false;                        
            }) 
        }

    });

</script>
