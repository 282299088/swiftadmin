layui.define(function(a){var o=layui.jquery,n=layui.table,t=(layui.flow,layui.form),c=layui.admin.lang,l=window.location.href.split("://")[1],e=l.indexOf("/"),i=l.indexOf(".php")+4,s=l.substring(e,i),r=[800<o(window).width()?"660px":"85%",800<o(window).height()?"680px":"85%"],d={apiUrl:window.atob("aHR0cHM6Ly9hcGkuc3dpZnRhZG1pbi5uZXQ="),install:function(t,a,n){o.post(s+n,{name:t,token:a},function(a){if(layer.closeAll(),200!=a.code)return layer.msg(a.msg,"error"),-101==a.code?(d.login(),!1):-102==a.code?(d.pay(a.data),!1):void 0;layer.msg(a.msg);var l,e=layui.sessionData("api_install_index").index,i=o('tr[data-index="'+e+'"]');-1!=n.indexOf("install")?(l="",e='<input type="checkbox" lay-filter="switchStatus" lay-url="',e+=s+'/system.plugin/status" value="'+t+'" lay-skin="switch" checked="">',e+='<div class="layui-unselect layui-form-switch layui-form-onswitch" lay-skin="_switch"><em></em><i></i></div>',o(i).find('[data-field="status"]').children("div").append(e),data=a.data||[],data.config&&(l+='<a class="layui-table-text" lay-title="'+c("配置插件")+'"',l+='lay-area="'+data.area+'" lay-maxmin="true"',l+='lay-url="'+s+"/system.plugin/config/name/"+t+'" ',l+='lay-event="edit">'+c("配置")+"</a>",l+='<div class="layui-divider layui-divider-vertical"></div> '),l+='<a class="layui-table-text uninstall" style="color:red"',l+='lay-url="'+s+"/system.plugin/uninstall/name/"+t+'">'+c("卸载")+"</a> ",o(i).find("td:last").children("div").html(l),window.plugins[t]=a.data):(i.find(".layui-upgrade-elem").remove(),i.find(".layui-form-switch").addClass("bubble"),i.find(".layui-form-switch").trigger("click",["stopPropagation"])),layui.admin.saPHPInit(!0)},"json")},login:function(){layer.open({type:1,title:"登录",shadeClose:!0,area:["500px","350px"],content:d.getHtml(),success:function(a,l){t.on("submit(login)",function(a){return o.post(d.apiUrl+"/user/login",a.field,function(a){200==a.code?(layui.admin.setStorage("api_cross_token",a.data.token),layer.closeAll(),d.againclick()):layer.msg(a.msg,"error")},"json"),!1})}})},clearLogin:function(){layui.admin.setStorage("api_cross_token",null)},pay:function(a){layer.open({type:2,title:c("立即支付"),area:r,offset:"30px",resize:!1,shade:.8,shadeClose:!0,content:a.payurl,success:function(a,e){window.onmessage=function(a){var l=a.data;null!==a.data&&200==l.code&&(layer.close(e),d.againclick()),null!==a.data&&-133==l.code&&layer.close(e)}}})},againclick:function(){try{var a=layui.sessionData("api_install_index").index,l=o('tr[data-index="'+a+'"]').children().find(".install");(l=l.length<=0?o('[layui-value="'+a+'"]'):l)&&null!=a&&o(l).trigger("click")}catch(a){console.log(a)}},uninstall:function(t,a){o.post(s+d.getUrl("plugin","uninstall"),{name:t,tables:a},function(a){var l,e,i;200==a.code?(layer.msg(a.msg),i=layui.sessionData("api_install_index").index,l=o('tr[data-index="'+i+'"]'),o(l).find('[data-field="status"]').children("div").html(""),e='<a class="layui-table-text install" lay-url="'+s,e+="/system.plugin/install/name/"+t+'">'+c("安装")+"</a>",void 0!==(i=n.cache["lay-tableList"][i]).demourl&&(e+='<div class="layui-divider layui-divider-vertical"></div>',e+='<a class="layui-table-text" target="_blank" href="',e+=i.demourl+'">'+c("演示")+"</a>"),delete window.plugins[t],o(l).find("td:last").children("div").html(e),layui.admin.saPHPInit(!0)):layer.msg(a.msg,"error"),layer.closeAll()},"json")},getUrl(a,l){return"/system."+a+"/"+l},getTableData:function(a){if(null==a||"undefined"==a)return!1;var a=o(a).parents("tr").attr("data-index");return a=n.cache["lay-tableList"][a]},getHtml:function(){return'<form class="layui-form layui-form-fixed" style="padding-right:15px;" ><blockquote class="layui-elem-quote layui-elem-plugin"></blockquote><div style="height:20px;"></div><div class="layui-form-item"><label class="layui-form-label">用户帐号</label><div class="layui-input-block"><input type="text" name="nickname" style="width:330px;" lay-verify="required" placeholder="请输入帐号" class="layui-input" ></div></div><div class="layui-form-item"><label class="layui-form-label">密码</label><div class="layui-input-block"><input type="password" name="pwd" style="width:330px;" lay-verify="required" placeholder="请输入密码" class="layui-input"></div></div><div class="layui-form-item" style="margin-top: 22px;text-align: center;"><a class="layui-btn layui-btn-primary" href="http://www.swiftadmin.net/user/register" target="_blank">注册</a><button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="login">登录</button></div></form> '}};o(".layui-plugin-select").click(function(a){var l=o(this);l.hasClass("active")&&!l.hasClass("first")?(l.removeClass("active"),l.siblings("span.first").addClass("active")):(l.siblings(".active").removeClass("active"),l.addClass("active"));var i={};o(".active").each(function(a,l){var e=o(l).attr("lay-value")||"",l=o(l).parent().attr("name");i[l]=e});var e,t=["type","pay","label"];for(e in t)i[t[e]]||(i[t[e]]="");n.reload("lay-tableList",{where:i,url:d.apiUrl+"/plugin/index"})}),o(document).on("click",".install,.upgrade",function(a){var l,e=o(this),i=layer.load(),t=e.attr("class"),n=e.attr("lay-type")||"plugin",s=t.replace("layui-table-text","").replace(/(^\s*)|(\s*$)/g,""),r=d.getTableData(this).name,u=layui.admin.getStorage("api_cross_token")||null;if(layui.sessionData("api_install_index",{key:"index",value:d.getTableData(this).LAY_TABLE_INDEX}),null==u||"undefined"==u)return layer.close(i),d.login(),!1;-1!=s.indexOf("upgrade")?(t='<div class="lay-upgrade">确认升级《<font size="4">'+r+"</font>》插件？<br/>",t+='<font color="red">1、请务必做好代码和数据库备份！</font><br/>',t+='<font color="red">2、升级后如出现冗余数据，请根据需要移除即可！</font><br/>',t+='<font color="red">3、生产环境下更新插件，请勿在流量高峰期操作！</font><br/></div>',l=layer.confirm(t,{title:c("更新提示")},function(){layer.close(l),d.install(r,u,d.getUrl(n,s))},function(){layer.close(i)})):d.install(r,u,d.getUrl(n,s))}),t.on("switch(pluginStatus)",function(l){var a=o(this),e={error:function(a){o(l.elem).prop("checked",!l.elem.checked),t.render("checkbox"),layer.msg(a.msg,"error")},success:function(a){layer.msg(a.msg),window.plugins[i.id].status=i.status,layui.admin.saPHPInit(!0)}},i={id:o(this).attr("value"),status:l.elem.checked?1:0};if(o(".bubble").length)return o(".bubble").removeClass("bubble"),!1;layui.admin.event.ajax(a,i,e)}),o(document).on("click",".uninstall",function(a){var i=d.getTableData(this).name,l='<form class="layui-form layui-form-fixed" style="padding-right:15px;" >';l+='<blockquote class="layui-elem-quote layui-elem-uninstall">温馨提示<br/>',l+="确认卸载 《"+i+"》 吗？<br/>",l+="1、卸载前请自行备份插件数据库 ！<br/>",l+="2、插件文件及数据库表删除后无法找回 ！<br/>",l+="3、插件如已被二次开发，请自行清除冗余文件！<br/>",l+="</blockquote>",l+='<div class="layui-form-item">',l+='<div class="layui-input-inline" style="padding-left: 5px;">',l+='<input type="checkbox" lay-filter="tables" lay-skin="primary" title="删除插件相关数据库表" >',l+='<div class="layui-plugin-tables layui-badge-red"></div></div></div>',l+='<div class="layui-footer" style="margin-top: 22px;text-align: center;">',l+='<button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="start">确定</button>',l+='<button type="button" class="layui-btn layui-btn-primary" sa-event="closeDialog" >关闭</button>',l+="</div></form> ",layui.sessionData("api_install_index",{key:"index",value:d.getTableData(this).LAY_TABLE_INDEX}),layer.open({type:1,title:c("卸载插件"),shadeClose:!0,area:["380px","360px"],content:l,success:function(a,l){t.render(),t.on("checkbox(tables)",function(a){a.elem.checked?o.get(s+"/system.plugin/tables",{name:i},function(a){try{if(200==a.code&&a.data.tables){var l,e=[];for(l in o(".layui-plugin-tables").append("<span>即将删除数据表：</span>").show(),a.data.tables){e.push([a.data.tables[l]]);var i="<span>"+a.data.tables[l]+"</span>、";o(".layui-plugin-tables").append(i)}}else layer.msg(a.msg,"error")}catch(a){console.log(a)}},"json"):o(".layui-plugin-tables").html("").hide()}),t.on("submit(start)",function(a){var e=[];return o(".layui-plugin-tables").children("span").each(function(a,l){1<=a&&e.push(o(l).html())}),layer.load(),layer.close(l),d.uninstall(i,e),!1})}})}),o("*[lay-value=install]").click(function(a){n.reload("lay-tableList",{url:s+"/system.plugin/index?type=install"})}),o("*[lay-value=cache]").click(function(a){var l=layer.confirm("确定要更新缓存吗？",{title:"更新提示"},function(){o.get(s+d.getUrl("admin","clear/type/plugin"),{},function(a){200==a.code?(layer.msg(a.msg),layer.close(l)):layer.msg(a.msg,"error")})})}),o("body").on("click",".layui-icon-picture",function(a){var l=d.getTableData(this),e=[];if(l.album)for(var i in l.album)e.push({src:l.album[i].src,thumb:l.album[i].src});layer.photos({photos:{data:e},shadeClose:!0,closeBtn:2,anim:10})}),a("plugin",d)});